generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  phone     String?  @unique
  gender    String?
  // 'free' or 'pro' plan for feature gating
  plan      String   @default("free")
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)
  createdAt DateTime @default(now())
  gratitudeEntries GratitudeEntry[]
  tasks     Task[]
  visionItems VisionItem[]
  method369Entries Method369Entry[]
  focusSessions FocusSession[]
  timerPauses   TimerPause[]
  timerStops    TimerStop[]
  categories     UserCategory[]
  subscriptions  UserSubscription[]
  emailTokens    EmailVerificationToken[]
  phoneCodes     PhoneVerificationCode[]
  profile        UserProfile?
}

model UserProfile {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  dob             DateTime?
  profileImageUrl String?
  bio             String?  @db.Text
  timezone        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])
}

model ContactMessage {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}

model GratitudeEntry {
  id         Int      @id @default(autoincrement())
  userId     Int
  period     String
  periodKey  String
  payload    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@unique([userId, period, periodKey])
}

model Task {
  id         String   @id
  userId     Int
  title      String
  category   String
  done       Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model VisionItem {
  id         String   @id
  userId     Int
  title      String
  imageUrl   String?
  description String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Method369Entry {
  id         String   @id
  userId     Int
  phrase     String
  date       DateTime
  morningCount  Int   @default(0)
  afternoonCount Int  @default(0)
  eveningCount   Int  @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@unique([userId, date])
}

model FocusSession {
  id         String   @id
  userId     Int
  startAt    DateTime
  endAt      DateTime?
  // Planned duration in minutes at start
  plannedMinutes Int?
  // Actual total minutes (computed on stop)
  durationMinutes Int?
  // 'focus' or 'break'
  mode       String  @default("focus")
  // For restoring an active countdown across refresh
  targetEnd  DateTime?
  note       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id])
  pauses     TimerPause[]
  stops      TimerStop[]

  @@index([userId])
}

model TimerPause {
  id         String   @id
  sessionId  String
  userId     Int
  startedAt  DateTime
  endedAt    DateTime?
  createdAt  DateTime @default(now())

  session    FocusSession @relation(fields: [sessionId], references: [id])
  user       User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionId])
}

model TimerStop {
  id         String   @id
  sessionId  String
  userId     Int
  stoppedAt  DateTime
  createdAt  DateTime @default(now())

  session    FocusSession @relation(fields: [sessionId], references: [id])
  user       User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionId])
}

model UserCategory {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@unique([userId, name])
}

model SubscriptionPlan {
  id                  Int      @id @default(autoincrement())
  key                 String   @unique // e.g. 'free', 'silver', 'ultimate'
  name                String
  priceMonthlyCents   Int      @default(0)
  priceYearlyCents    Int      @default(0)
  yearlyDiscountPercent Int?
  limits              Json?
  permissions         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  subscriptions       UserSubscription[]
}

model UserSubscription {
  id         Int      @id @default(autoincrement())
  userId     Int
  planId     Int
  status     String   @default("active") // 'active', 'canceled', 'expired'
  startedAt  DateTime @default(now())
  expiresAt  DateTime?
  cancelAt   DateTime?

  user       User              @relation(fields: [userId], references: [id])
  plan       SubscriptionPlan  @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([planId])
}

model EmailVerificationToken {
  id         String   @id
  userId     Int
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PhoneVerificationCode {
  id         String   @id
  userId     Int
  code       String
  expiresAt  DateTime
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}
